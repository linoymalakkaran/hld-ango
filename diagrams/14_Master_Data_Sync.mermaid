graph TD
    %% Scheduler
    subgraph Scheduler["â° BATCH SCHEDULER"]
        CronJob[ğŸ• Cron Job Scheduler<br/>Daily at 02:00 AM WAT<br/>Kubernetes CronJob]
    end

    %% Master Data Management Service
    subgraph MasterDataService["ğŸ—‚ï¸ MASTER DATA MANAGEMENT SERVICE"]
        direction TB
        
        subgraph SyncOrchestrator["Synchronization Orchestrator"]
            SyncManager[ğŸ”„ Sync Manager<br/>â€¢ Process Coordination<br/>â€¢ Error Handling<br/>â€¢ Rollback Management<br/>â€¢ Progress Tracking]
            
            ValidationEngine[âœ… Validation Engine<br/>â€¢ Data Integrity Checks<br/>â€¢ Schema Validation<br/>â€¢ Business Rule Verification<br/>â€¢ Conflict Detection]
            
            TransformationEngine[ğŸ”„ Transformation Engine<br/>â€¢ Format Conversion<br/>â€¢ Data Mapping<br/>â€¢ Standardization<br/>â€¢ Enrichment]
            
            DistributionEngine[ğŸ“¤ Distribution Engine<br/>â€¢ Service Notification<br/>â€¢ Delta Distribution<br/>â€¢ Version Management<br/>â€¢ Dependency Resolution]
        end
    end

    %% External Data Sources
    subgraph ExternalSources["ğŸŒ EXTERNAL DATA SOURCES"]
        direction TB
        
        subgraph GovernmentSources["Government Sources"]
            AGTSystems[ğŸ›ï¸ AGT Customs Authority<br/>â€¢ HS Codes & Classifications<br/>â€¢ Tariff Schedules<br/>â€¢ Duty Rates<br/>â€¢ Customs Office Codes<br/>Protocol: SFTP/API]
            
            SINTECESystems[ğŸ›ï¸ SINTECE<br/>â€¢ License Types<br/>â€¢ Regulatory Updates<br/>â€¢ Certificate Templates<br/>â€¢ Compliance Rules<br/>Protocol: REST API]
            
            OGASystems[ğŸ›ï¸ OGA Systems<br/>â€¢ Permit Requirements<br/>â€¢ Restricted Goods Lists<br/>â€¢ Agency Contacts<br/>â€¢ Processing Fees<br/>Protocol: REST API/FTP]
        end
        
        subgraph InternationalSources["International Sources"]
            WCOUpdates[ğŸŒ World Customs Organization<br/>â€¢ HS Code Updates<br/>â€¢ Classification Changes<br/>â€¢ Best Practices<br/>â€¢ Standards Updates<br/>Protocol: HTTPS/FTP]
            
            CurrencyAPI[ğŸ’± Currency Exchange APIs<br/>â€¢ Real-time Exchange Rates<br/>â€¢ Historical Data<br/>â€¢ Central Bank Rates<br/>Protocol: REST API]
            
            ISOStandards[ğŸ“Š ISO Standards<br/>â€¢ Country Codes (ISO 3166)<br/>â€¢ Currency Codes (ISO 4217)<br/>â€¢ Unit Codes<br/>Protocol: Data Feed]
        end
        
        subgraph CommercialSources["Commercial Data Sources"]
            UNLOCODEData[ğŸŒ UN/LOCODE<br/>â€¢ Port Codes<br/>â€¢ Location Codes<br/>â€¢ Terminal Information<br/>Protocol: Data Feed]
            
            TradeData[ğŸ“ˆ Trade Statistics<br/>â€¢ Import/Export Volumes<br/>â€¢ Market Intelligence<br/>â€¢ Price Indices<br/>Protocol: API/Feed]
        end
    end

    %% Master Data Database
    subgraph MasterDataDB["ğŸ—ƒï¸ MASTER DATA DATABASE"]
        direction TB
        
        MasterDB[(ğŸ—ƒï¸ PostgreSQL 15+<br/>masterdata_db)]
        
        subgraph MasterTables["Master Data Tables"]
            HSCodesTable[(ğŸ·ï¸ hs_codes<br/>â€¢ hs_code (6-10 digits)<br/>â€¢ description<br/>â€¢ unit_of_measure<br/>â€¢ effective_date<br/>â€¢ version)]
            
            TariffTable[(ğŸ’° tariff_schedules<br/>â€¢ hs_code<br/>â€¢ origin_country<br/>â€¢ duty_rate<br/>â€¢ vat_rate<br/>â€¢ effective_date)]
            
            CountryTable[(ğŸŒ countries<br/>â€¢ country_code (ISO 3166)<br/>â€¢ country_name<br/>â€¢ region<br/>â€¢ trade_agreements)]
            
            CurrencyTable[(ğŸ’± currencies<br/>â€¢ currency_code (ISO 4217)<br/>â€¢ currency_name<br/>â€¢ exchange_rate<br/>â€¢ last_updated)]
            
            PortsTable[(ğŸš¢ ports<br/>â€¢ port_code (UN/LOCODE)<br/>â€¢ port_name<br/>â€¢ country<br/>â€¢ coordinates<br/>â€¢ customs_office)]
            
            CustomsOfficeTable[(ğŸ›ï¸ customs_offices<br/>â€¢ office_code<br/>â€¢ office_name<br/>â€¢ location<br/>â€¢ operating_hours<br/>â€¢ contact_info)]
            
            LicenseTypesTable[(ğŸ“œ license_types<br/>â€¢ license_code<br/>â€¢ license_name<br/>â€¢ required_documents<br/>â€¢ validity_period<br/>â€¢ issuing_agency)]
            
            ProhibitedGoodsTable[(ğŸš« prohibited_goods<br/>â€¢ hs_code<br/>â€¢ country_origin<br/>â€¢ restriction_type<br/>â€¢ exemptions<br/>â€¢ effective_date)]
        end
        
        subgraph VersionControl["Version Control Tables"]
            SyncHistoryTable[(ğŸ“… sync_history<br/>â€¢ sync_id<br/>â€¢ sync_date<br/>â€¢ status<br/>â€¢ records_processed<br/>â€¢ errors_count)]
            
            DataVersionTable[(ğŸ”„ data_versions<br/>â€¢ table_name<br/>â€¢ version_number<br/>â€¢ last_updated<br/>â€¢ checksum)]
            
            ChangeLogTable[(ğŸ“ change_log<br/>â€¢ change_id<br/>â€¢ table_name<br/>â€¢ record_id<br/>â€¢ change_type<br/>â€¢ old_value<br/>â€¢ new_value<br/>â€¢ timestamp)]
        end
    end

    %% Target Microservice Databases
    subgraph TargetDatabases["ğŸ—ƒï¸ TARGET MICROSERVICE DATABASES"]
        direction TB
        
        subgraph CoreServiceDBs["Core Service Databases"]
            CompanyDB[(ğŸ¢ company_db<br/>Reference Data Cache)]
            LicenseDB[(ğŸ“œ license_db<br/>License Types & Rules)]
            DeclarationDB[(ğŸ“‹ declaration_db<br/>HS Codes & Tariffs)]
            DocumentDB[(ğŸ“„ document_db<br/>Document Types)]
        end
        
        subgraph IntegrationServiceDBs["Integration Service Databases"]
            ASYCUDAIntegrationDB[(ğŸ›ï¸ asycuda_integration_db<br/>ASYCUDA Reference Data)]
            SINTECEIntegrationDB[(ğŸ›ï¸ sintece_integration_db<br/>SINTECE Reference Data)]
            OGAIntegrationDB[(ğŸ›ï¸ oga_integration_db<br/>OGA Reference Data)]
        end
        
        subgraph CrossCuttingDBs["Cross-Cutting Service Databases"]
            NotificationDB[(ğŸ“§ notification_db<br/>Template Data)]
            ReportingDB[(ğŸ“Š reporting_db<br/>Dimension Tables)]
            AuditDB[(ğŸ“ audit_db<br/>Reference Data)]
        end
    end

    %% Cache Layer
    subgraph CacheLayer["âš¡ CACHE LAYER"]
        RedisCache[âš¡ Redis Cluster<br/>â€¢ Frequently Accessed Data<br/>â€¢ HS Code Lookups<br/>â€¢ Exchange Rates<br/>â€¢ Tariff Schedules<br/>TTL: 24 Hours]
    end

    %% Message Queue for Distribution
    subgraph MessageQueue["ğŸ“¬ MESSAGE QUEUE"]
        RabbitMQ[ğŸ° RabbitMQ<br/>â€¢ Master Data Change Events<br/>â€¢ Service Notifications<br/>â€¢ Error Notifications<br/>â€¢ Distribution Queues]
    end

    %% Notification System
    subgraph NotificationSystem["ğŸ“§ NOTIFICATION SYSTEM"]
        NotificationService[ğŸ“§ Notification Service<br/>â€¢ Sync Status Reports<br/>â€¢ Error Alerts<br/>â€¢ Change Notifications<br/>â€¢ Admin Dashboards]
    end

    %% Monitoring and Alerting
    subgraph Monitoring["ğŸ“Š MONITORING & ALERTING"]
        direction TB
        
        SyncMonitoring[ğŸ“Š Sync Monitoring<br/>â€¢ Process Status<br/>â€¢ Performance Metrics<br/>â€¢ Data Quality Checks<br/>â€¢ SLA Tracking]
        
        Alerting[ğŸš¨ Alerting System<br/>â€¢ Failed Sync Alerts<br/>â€¢ Data Quality Issues<br/>â€¢ Performance Degradation<br/>â€¢ Source System Outages]
    end

    %% Synchronization Flow
    subgraph SyncFlow["ğŸ”„ NIGHTLY SYNC PROCESS"]
        direction LR
        
        Step1[1ï¸âƒ£ Initialize Sync<br/>Check Sources]
        Step2[2ï¸âƒ£ Extract Data<br/>Fetch Updates]
        Step3[3ï¸âƒ£ Transform Data<br/>Validate & Convert]
        Step4[4ï¸âƒ£ Load Data<br/>Update Master DB]
        Step5[5ï¸âƒ£ Distribute Changes<br/>Notify Services]
        Step6[6ï¸âƒ£ Verify Distribution<br/>Confirm Updates]
        Step7[7ï¸âƒ£ Generate Reports<br/>Send Notifications]
        
        Step1 --> Step2
        Step2 --> Step3
        Step3 --> Step4
        Step4 --> Step5
        Step5 --> Step6
        Step6 --> Step7
    end

    %% Error Handling and Recovery
    subgraph ErrorHandling["âš ï¸ ERROR HANDLING & RECOVERY"]
        direction TB
        
        RetryMechanism[ğŸ”„ Retry Mechanism<br/>â€¢ Exponential Backoff<br/>â€¢ Max Retry Limits<br/>â€¢ Circuit Breaker<br/>â€¢ Dead Letter Queue]
        
        RollbackProcedure[â†©ï¸ Rollback Procedure<br/>â€¢ Version Restoration<br/>â€¢ Data Consistency<br/>â€¢ Service Notification<br/>â€¢ Audit Trail]
        
        ManualIntervention[ğŸ‘¨â€ğŸ’» Manual Intervention<br/>â€¢ Admin Dashboard<br/>â€¢ Error Investigation<br/>â€¢ Manual Sync Trigger<br/>â€¢ Data Correction]
    end

    %% Data Quality Validation
    subgraph DataQuality["ğŸ¯ DATA QUALITY VALIDATION"]
        direction TB
        
        SchemaValidation[ğŸ“‹ Schema Validation<br/>â€¢ Required Fields<br/>â€¢ Data Types<br/>â€¢ Format Checks<br/>â€¢ Constraint Validation]
        
        BusinessRuleValidation[âœ… Business Rule Validation<br/>â€¢ Logical Consistency<br/>â€¢ Cross-Reference Checks<br/>â€¢ Duplicate Detection<br/>â€¢ Completeness Verification]
        
        DataIntegrityChecks[ğŸ” Data Integrity Checks<br/>â€¢ Referential Integrity<br/>â€¢ Checksum Validation<br/>â€¢ Version Consistency<br/>â€¢ Audit Trail Verification]
    end

    %% Main Flow Connections
    CronJob --> SyncManager
    SyncManager --> ExternalSources
    ExternalSources --> ValidationEngine
    ValidationEngine --> TransformationEngine
    TransformationEngine --> MasterDB
    MasterDB --> DistributionEngine
    DistributionEngine --> TargetDatabases
    DistributionEngine --> RedisCache
    DistributionEngine --> RabbitMQ
    RabbitMQ --> NotificationService

    %% Monitoring Connections
    SyncManager -.-> Monitoring
    ValidationEngine -.-> Monitoring
    DistributionEngine -.-> Monitoring
    Monitoring --> NotificationService

    %% Error Handling Connections
    SyncManager --> ErrorHandling
    ValidationEngine --> ErrorHandling
    TransformationEngine --> ErrorHandling

    %% Data Quality Connections
    ValidationEngine --> DataQuality
    TransformationEngine --> DataQuality

    %% Sync Process Flow
    SyncFlow -.-> SyncManager

    %% Real-time Updates Flow
    subgraph RealTimeUpdates["âš¡ REAL-TIME UPDATES"]
        direction LR
        
        ExchangeRateAPI[ğŸ’± Exchange Rate API<br/>Hourly Updates]
        CriticalUpdates[ğŸš¨ Critical Updates<br/>Emergency Changes]
        
        ExchangeRateAPI --> RedisCache
        CriticalUpdates --> RabbitMQ
    end

    %% Performance Optimization
    subgraph PerformanceOptimization["ğŸš€ PERFORMANCE OPTIMIZATION"]
        direction TB
        
        IncrementalSync[ğŸ“ˆ Incremental Sync<br/>â€¢ Delta Detection<br/>â€¢ Timestamp Comparison<br/>â€¢ Change Detection<br/>â€¢ Efficient Updates]
        
        ParallelProcessing[âš¡ Parallel Processing<br/>â€¢ Multi-threaded Extraction<br/>â€¢ Concurrent Validation<br/>â€¢ Parallel Distribution<br/>â€¢ Load Balancing]
        
        Compression[ğŸ“¦ Data Compression<br/>â€¢ Transfer Optimization<br/>â€¢ Storage Efficiency<br/>â€¢ Network Bandwidth<br/>â€¢ Processing Speed]
    end

    %% Styling
    classDef serviceBox fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px,color:#000
    classDef dataBox fill:#e1f5fe,stroke:#01579b,stroke-width:2px,color:#000
    classDef externalBox fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#000
    classDef processBox fill:#fff3e0,stroke:#ef6c00,stroke-width:2px,color:#000
    classDef monitorBox fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    classDef cacheBox fill:#f1f8e9,stroke:#33691e,stroke-width:2px,color:#000

    class MasterDataService,NotificationSystem serviceBox
    class MasterDataDB,TargetDatabases dataBox
    class ExternalSources externalBox
    class SyncFlow,ErrorHandling,DataQuality,PerformanceOptimization processBox
    class Monitoring monitorBox
    class CacheLayer,MessageQueue cacheBox