%%{init: {'theme':'base', 'themeVariables': {'fontSize': '10px', 'fontFamily': 'Arial, sans-serif'}}}%%
graph TD
    %% Scheduler
    subgraph Scheduler["â° BATCH SCHEDULER"]
        CronJob[ðŸ• Cron Job Scheduler]
    end

    %% Master Data Management Service
    subgraph MasterDataService["ðŸ—‚ï¸ MASTER DATA SERVICE"]
        SyncManager[ðŸ”„ Sync Manager]
        ValidationEngine[âœ… Validation Engine]
        TransformationEngine[ðŸ”„ Transformation Engine]
        DistributionEngine[ðŸ“¤ Distribution Engine]
    end

    %% External Data Sources
    subgraph ExternalSources["ðŸŒ EXTERNAL SOURCES"]
        AGTSystems[ðŸ›ï¸ AGT Customs Authority]
        SINTECESystems[ðŸ›ï¸ SINTECE]
        OGASystems[ðŸ›ï¸ OGA Systems]
        WCOUpdates[ðŸŒ WCO Updates]
        CurrencyAPI[ðŸ’± Currency Exchange APIs]
        ISOStandards[ðŸ“Š ISO Standards]
        UNLOCODEData[ðŸŒ UN/LOCODE]
        TradeData[ðŸ“ˆ Trade Statistics]
    end

    %% Master Data Database
    subgraph MasterDataDB["ðŸ—ƒï¸ MASTER DATA DB"]
        MasterDB[(ðŸ—ƒï¸ PostgreSQL)]
        HSCodesTable[(ðŸ·ï¸ HS Codes)]
        TariffTable[(ðŸ’° Tariff Schedules)]
        CountryTable[(ðŸŒ Countries)]
        CurrencyTable[(ðŸ’± Currencies)]
        PortsTable[(ðŸš¢ Ports)]
        CustomsOfficeTable[(ðŸ›ï¸ Customs Offices)]
        LicenseTypesTable[(ðŸ“œ License Types)]
        SyncHistoryTable[(ðŸ“… Sync History)]
    end

    %% Target Microservice Databases
    subgraph TargetDatabases["ðŸ—ƒï¸ TARGET DATABASES"]
        CompanyDB[(ðŸ¢ Company DB)]
        LicenseDB[(ðŸ“œ License DB)]
        DeclarationDB[(ðŸ“‹ Declaration DB)]
        DocumentDB[(ðŸ“„ Document DB)]
        ASYCUDAIntegrationDB[(ðŸ›ï¸ ASYCUDA Integration DB)]
        SINTECEIntegrationDB[(ðŸ›ï¸ SINTECE Integration DB)]
        NotificationDB[(ðŸ“§ Notification DB)]
        ReportingDB[(ðŸ“Š Reporting DB)]
    end

    %% Cache Layer
    subgraph CacheLayer["âš¡ CACHE LAYER"]
        RedisCache[âš¡ Redis Cluster]
    end

    %% Message Queue
    subgraph MessageQueue["ðŸ“¬ MESSAGE QUEUE"]
        RabbitMQ[ðŸ° RabbitMQ]
    end

    %% Notification System
    subgraph NotificationSystem["ðŸ“§ NOTIFICATION"]
        NotificationService[ðŸ“§ Notification Service]
    end

    %% Monitoring
    subgraph Monitoring["ðŸ“Š MONITORING"]
        SyncMonitoring[ðŸ“Š Sync Monitoring]
        Alerting[ðŸš¨ Alerting System]
    end

    %% Sync Process Flow
    subgraph SyncFlow["ðŸ”„ SYNC PROCESS"]
        Step1[1ï¸âƒ£ Initialize Sync]
        Step2[2ï¸âƒ£ Extract Data]
        Step3[3ï¸âƒ£ Transform Data]
        Step4[4ï¸âƒ£ Load Data]
        Step5[5ï¸âƒ£ Distribute Changes]
        Step6[6ï¸âƒ£ Verify Distribution]
        Step7[7ï¸âƒ£ Generate Reports]
    end

    %% Error Handling
    subgraph ErrorHandling["âš ï¸ ERROR HANDLING"]
        RetryMechanism[ðŸ”„ Retry Mechanism]
        RollbackProcedure[â†©ï¸ Rollback Procedure]
        ManualIntervention[ðŸ‘¨â€ðŸ’» Manual Intervention]
    end

    %% Data Quality
    subgraph DataQuality["ðŸŽ¯ DATA QUALITY"]
        SchemaValidation[ðŸ“‹ Schema Validation]
        BusinessRuleValidation[âœ… Business Rule Validation]
        DataIntegrityChecks[ðŸ” Data Integrity Checks]
    end

    %% Real-time Updates
    subgraph RealTimeUpdates["âš¡ REAL-TIME UPDATES"]
        ExchangeRateAPI[ðŸ’± Exchange Rate API]
        CriticalUpdates[ðŸš¨ Critical Updates]
    end

    %% Performance Optimization
    subgraph PerformanceOptimization["ðŸš€ PERFORMANCE"]
        IncrementalSync[ðŸ“ˆ Incremental Sync]
        ParallelProcessing[âš¡ Parallel Processing]
        Compression[ðŸ“¦ Data Compression]
    end

    %% Main Flow Connections
    CronJob --> SyncManager
    SyncManager --> ExternalSources
    ExternalSources --> ValidationEngine
    ValidationEngine --> TransformationEngine
    TransformationEngine --> MasterDB
    MasterDB --> DistributionEngine
    DistributionEngine --> TargetDatabases
    DistributionEngine --> RedisCache
    DistributionEngine --> RabbitMQ
    RabbitMQ --> NotificationService

    %% Sync Process Flow
    Step1 --> Step2
    Step2 --> Step3
    Step3 --> Step4
    Step4 --> Step5
    Step5 --> Step6
    Step6 --> Step7

    %% Supporting Connections
    SyncManager -.-> Monitoring
    ValidationEngine -.-> Monitoring
    ValidationEngine --> DataQuality
    SyncManager --> ErrorHandling
    TransformationEngine --> DataQuality
    
    %% Real-time Updates
    ExchangeRateAPI --> RedisCache
    CriticalUpdates --> RabbitMQ
    
    %% Performance Connections
    SyncManager --> PerformanceOptimization
    DistributionEngine --> PerformanceOptimization

    %% Main Flow Connections
    CronJob --> SyncManager
    SyncManager --> ExternalSources
    ExternalSources --> ValidationEngine
    ValidationEngine --> TransformationEngine
    TransformationEngine --> MasterDB
    MasterDB --> DistributionEngine
    DistributionEngine --> TargetDatabases
    DistributionEngine --> RedisCache
    DistributionEngine --> RabbitMQ
    RabbitMQ --> NotificationService

    %% Monitoring Connections
    SyncManager -.-> Monitoring
    ValidationEngine -.-> Monitoring
    DistributionEngine -.-> Monitoring
    Monitoring --> NotificationService

    %% Error Handling Connections
    SyncManager --> ErrorHandling
    ValidationEngine --> ErrorHandling
    TransformationEngine --> ErrorHandling

    %% Data Quality Connections
    ValidationEngine --> DataQuality
    TransformationEngine --> DataQuality

    %% Sync Process Flow
    SyncFlow -.-> SyncManager

    %% Real-time Updates Flow
    subgraph RealTimeUpdates["âš¡ REAL-TIME UPDATES"]
        direction LR
        
        ExchangeRateAPI[ðŸ’± Exchange Rate API<br/>Hourly Updates]
        CriticalUpdates[ðŸš¨ Critical Updates<br/>Emergency Changes]
        
        ExchangeRateAPI --> RedisCache
        CriticalUpdates --> RabbitMQ
    end

    %% Performance Optimization
    subgraph PerformanceOptimization["ðŸš€ PERFORMANCE OPTIMIZATION"]
        direction TB
        
        IncrementalSync[ðŸ“ˆ Incremental Sync<br/>â€¢ Delta Detection<br/>â€¢ Timestamp Comparison<br/>â€¢ Change Detection<br/>â€¢ Efficient Updates]
        
        ParallelProcessing[âš¡ Parallel Processing<br/>â€¢ Multi-threaded Extraction<br/>â€¢ Concurrent Validation<br/>â€¢ Parallel Distribution<br/>â€¢ Load Balancing]
        
        Compression[ðŸ“¦ Data Compression<br/>â€¢ Transfer Optimization<br/>â€¢ Storage Efficiency<br/>â€¢ Network Bandwidth<br/>â€¢ Processing Speed]
    end

    %% Styling
    classDef serviceBox fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px,color:#000
    classDef dataBox fill:#e1f5fe,stroke:#01579b,stroke-width:2px,color:#000
    classDef externalBox fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#000
    classDef processBox fill:#fff3e0,stroke:#ef6c00,stroke-width:2px,color:#000
    classDef monitorBox fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    classDef cacheBox fill:#f1f8e9,stroke:#33691e,stroke-width:2px,color:#000

    class MasterDataService,NotificationSystem serviceBox
    class MasterDataDB,TargetDatabases dataBox
    class ExternalSources externalBox
    class SyncFlow,ErrorHandling,DataQuality,PerformanceOptimization processBox
    class Monitoring monitorBox
    class CacheLayer,MessageQueue cacheBox