%%{init: {'theme':'base', 'themeVariables': {'fontSize': '10px', 'fontFamily': 'Arial, sans-serif'}}}%%
graph TB
    %% Clients
    subgraph Clients["üë• CLIENTS"]
        WebApp[üåê JUL Portal]
        MobileApp[üì± Mobile App]
        APIClients[üîå API Clients]
    end

    %% Load Balancer
    subgraph LoadBalancer["‚öñÔ∏è NGINX"]
        NGINX[‚öñÔ∏è NGINX Ingress]
    end

    %% Keycloak Cluster
    subgraph KeycloakCluster["üîê KEYCLOAK"]
        KC1[üîê Keycloak Instance 1]
        KC2[üîê Keycloak Instance 2]
        KC3[üîê Keycloak Instance 3]
    end

    %% Database
    subgraph Database["üóÉÔ∏è DATABASE"]
        KeycloakDB[(üóÉÔ∏è PostgreSQL)]
        UsersTable[(üë§ Users)]
        RolesTable[(üõ°Ô∏è Roles)]
        SessionsTable[(üîÑ Sessions)]
    end

    %% External Providers
    subgraph ExternalProviders["üåê EXTERNAL"]
        LDAPProvider[üìÅ LDAP/AD]
        SocialProviders[üì± Social Login]
        GovernmentSSO[üèõÔ∏è Gov SSO]
    end

    %% JUL Services
    subgraph JULServices["‚öôÔ∏è JUL SERVICES"]
        CompanyService[üè¢ Company]
        LicenseService[üìú License]
        DeclarationService[üìã Declaration]
        DocumentService[üìÑ Document]
    end

    %% API Gateway
    subgraph APIGateway["ü¶ç GATEWAY"]
        Kong[ü¶ç Kong Gateway]
    end

    %% System Roles
    subgraph Roles["üõ°Ô∏è ROLES"]
        Admin[üë®‚Äçüíº Admin]
        Officer[üëÆ Officer]
        Supervisor[üë®‚Äçüíº Supervisor]
        Trader[üë§ Trader]
    end

    %% Authentication Protocols
    subgraph Protocols["üîë PROTOCOLS"]
        OAuth2[üîë OAuth 2.0]
        OpenIDConnect[üîê OpenID Connect]
        SAML[üìú SAML 2.0]
    end

    %% MFA Methods
    subgraph MFA["üîê MFA"]
        TOTP[üì± TOTP]
        SMS[üì± SMS]
        Email[üìß Email]
    end

    %% Connections
    Clients --> NGINX
    NGINX --> KeycloakCluster
    KeycloakCluster --> Database
    KeycloakCluster <--> ExternalProviders
    
    Clients --> Kong
    Kong <--> KeycloakCluster
    Kong --> JULServices
    
    KeycloakCluster --> Protocols
    KeycloakCluster --> MFA
    KeycloakCluster --> Roles
            
            CustomsBroker[üë• Customs Broker<br/>‚Ä¢ Client representation<br/>‚Ä¢ Declaration processing<br/>‚Ä¢ Agent services]
            
            FreightForwarder[üöõ Freight Forwarder<br/>‚Ä¢ Logistics management<br/>‚Ä¢ Shipment tracking<br/>‚Ä¢ Documentation]
            
            ReadOnlyUser[üëÅÔ∏è Read-Only User<br/>‚Ä¢ View access only<br/>‚Ä¢ Report generation<br/>‚Ä¢ Status inquiry]
        end
        
        subgraph Permissions["Fine-Grained Permissions"]
            DeclarationPerms[üìã Declaration Permissions<br/>‚Ä¢ create:declaration<br/>‚Ä¢ update:declaration<br/>‚Ä¢ delete:declaration<br/>‚Ä¢ approve:declaration]
            
            DocumentPerms[üìÑ Document Permissions<br/>‚Ä¢ upload:document<br/>‚Ä¢ view:document<br/>‚Ä¢ delete:document<br/>‚Ä¢ share:document]
            
            CompanyPerms[üè¢ Company Permissions<br/>‚Ä¢ create:company<br/>‚Ä¢ update:company<br/>‚Ä¢ view:company<br/>‚Ä¢ approve:company]
            
            ReportPerms[üìä Reporting Permissions<br/>‚Ä¢ view:reports<br/>‚Ä¢ generate:reports<br/>‚Ä¢ export:reports<br/>‚Ä¢ schedule:reports]
        end
    end

    %% Multi-Factor Authentication Flow
    subgraph MFAFlow["üîê MULTI-FACTOR AUTHENTICATION"]
        direction TB
        
        subgraph MFAMethods["MFA Methods"]
            TOTPAuth[üì± TOTP Authenticator<br/>‚Ä¢ Google Authenticator<br/>‚Ä¢ Microsoft Authenticator<br/>‚Ä¢ Time-based OTP]
            
            SMSAuth[üì± SMS Verification<br/>‚Ä¢ Angola Mobile Networks<br/>‚Ä¢ One-time Passcode<br/>‚Ä¢ Backup Method]
            
            EmailAuth[üìß Email Verification<br/>‚Ä¢ OTP via Email<br/>‚Ä¢ Backup Method<br/>‚Ä¢ Account Recovery]
        end
        
        subgraph MFAPolicy["MFA Policy"]
            MandatoryRoles[‚ö†Ô∏è Mandatory for:<br/>‚Ä¢ Customs Officers<br/>‚Ä¢ System Administrators<br/>‚Ä¢ Supervisors]
            
            OptionalRoles[‚ÑπÔ∏è Optional for:<br/>‚Ä¢ Traders<br/>‚Ä¢ Brokers<br/>‚Ä¢ Freight Forwarders]
        end
    end

    %% Session Management
    subgraph SessionMgmt["üîÑ SESSION MANAGEMENT"]
        direction TB
        
        subgraph SessionStore["Session Storage"]
            RedisCache[‚ö° Redis Cluster<br/>Session Store<br/>High Performance]
            
            SessionConfig[‚öôÔ∏è Session Configuration<br/>‚Ä¢ Timeout: 8 hours<br/>‚Ä¢ Refresh: 1 hour<br/>‚Ä¢ Max Concurrent: 3]
        end
        
        subgraph TokenManagement["Token Management"]
            AccessToken[üéüÔ∏è Access Token<br/>‚Ä¢ Validity: 1 hour<br/>‚Ä¢ JWT Format<br/>‚Ä¢ Role Claims]
            
            RefreshToken[üîÑ Refresh Token<br/>‚Ä¢ Validity: 8 hours<br/>‚Ä¢ Secure Storage<br/>‚Ä¢ Rotation Policy]
            
            IDToken[üÜî ID Token<br/>‚Ä¢ User Information<br/>‚Ä¢ OpenID Connect<br/>‚Ä¢ Profile Claims]
        end
    end

    %% Authentication Flows
    Clients --> NGINX
    NGINX --> KeycloakCluster
    
    %% Keycloak Internal Connections
    KC1 -.-> KeycloakPostgreSQL
    KC2 -.-> KeycloakPostgreSQL
    KC3 -.-> KeycloakPostgreSQL
    
    KeycloakServices --> DatabaseTables
    KeycloakProtocols --> KeycloakServices
    
    %% External Provider Integration
    KeycloakCluster <-.-> ExternalProviders
    
    %% Application Integration
    Clients --> APIGateway
    APIGateway <--> KeycloakCluster
    APIGateway --> JULServices
    
    %% Session and Token Flow
    KeycloakCluster <--> RedisCache
    KeycloakCluster --> TokenManagement
    
    %% Role and Permission Flow
    SystemRoles --> Permissions
    KeycloakCluster --> RoleManagement
    
    %% MFA Integration
    KeycloakCluster --> MFAFlow
    MFAMethods --> TOTPAuth
    MFAMethods --> SMSAuth
    MFAMethods --> EmailAuth

    %% User Registration and Company Association Flow
    subgraph UserFlow["üë§ USER REGISTRATION FLOW"]
        direction LR
        
        UserRegistration[1Ô∏è‚É£ User Registration<br/>Email + Password]
        EmailVerification[2Ô∏è‚É£ Email Verification<br/>Account Activation]
        CompanyAssociation[3Ô∏è‚É£ Company Association<br/>Link to Trading Company]
        RoleAssignment[4Ô∏è‚É£ Role Assignment<br/>Assign Appropriate Role]
        MFASetup[5Ô∏è‚É£ MFA Setup<br/>Configure 2FA]
        
        UserRegistration --> EmailVerification
        EmailVerification --> CompanyAssociation
        CompanyAssociation --> RoleAssignment
        RoleAssignment --> MFASetup
    end

    %% Styling
    classDef keycloakBox fill:#e1f5fe,stroke:#01579b,stroke-width:3px,color:#000
    classDef serviceBox fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px,color:#000
    classDef securityBox fill:#fff3e0,stroke:#ef6c00,stroke-width:2px,color:#000
    classDef dbBox fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    classDef externalBox fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#000
    classDef flowBox fill:#f1f8e9,stroke:#33691e,stroke-width:2px,color:#000

    class KeycloakCluster keycloakBox
    class JULServices,APIGateway serviceBox
    class RoleManagement,MFAFlow,SessionMgmt securityBox
    class KeycloakDB dbBox
    class ExternalProviders externalBox
    class UserFlow flowBox