%%{init: {'theme':'base', 'themeVariables': {'fontSize': '10px', 'fontFamily': 'Arial, sans-serif'}}}%%
graph TB
    %% Clients
    subgraph Clients["ðŸ‘¥ CLIENTS"]
        WebApp[ðŸŒ JUL Portal]
        MobileApp[ðŸ“± Mobile App]
        APIClients[ðŸ”Œ API Clients]
    end

    %% Load Balancer
    subgraph LoadBalancer["âš–ï¸ NGINX"]
        NGINX[âš–ï¸ NGINX Ingress]
    end

    %% Keycloak Cluster
    subgraph KeycloakCluster["ðŸ” KEYCLOAK"]
        KC1[ðŸ” Keycloak Instance 1]
        KC2[ðŸ” Keycloak Instance 2]
        KC3[ðŸ” Keycloak Instance 3]
    end

    %% Database
    subgraph Database["ðŸ—ƒï¸ DATABASE"]
        KeycloakDB[(ðŸ—ƒï¸ PostgreSQL)]
        UsersTable[(ðŸ‘¤ Users)]
        RolesTable[(ðŸ›¡ï¸ Roles)]
        SessionsTable[(ðŸ”„ Sessions)]
    end

    %% External Providers
    subgraph ExternalProviders["ðŸŒ EXTERNAL"]
        LDAPProvider[ðŸ“ LDAP/AD]
        SocialProviders[ðŸ“± Social Login]
        GovernmentSSO[ðŸ›ï¸ Gov SSO]
    end

    %% JUL Services
    subgraph JULServices["âš™ï¸ JUL SERVICES"]
        CompanyService[ðŸ¢ Company]
        LicenseService[ðŸ“œ License]
        DeclarationService[ðŸ“‹ Declaration]
        DocumentService[ðŸ“„ Document]
    end

    %% API Gateway
    subgraph APIGateway["ðŸ¦ GATEWAY"]
        Kong[ðŸ¦ Kong Gateway]
    end

    %% System Roles
    subgraph Roles["ðŸ›¡ï¸ ROLES"]
        Admin[ðŸ‘¨â€ðŸ’¼ Admin]
        Officer[ðŸ‘® Officer]
        Supervisor[ðŸ‘¨â€ðŸ’¼ Supervisor]
        Trader[ðŸ‘¤ Trader]
    end

    %% Authentication Protocols
    subgraph Protocols["ðŸ”‘ PROTOCOLS"]
        OAuth2[ðŸ”‘ OAuth 2.0]
        OpenIDConnect[ðŸ” OpenID Connect]
        SAML[ðŸ“œ SAML 2.0]
    end

    %% MFA Methods
    subgraph MFA["ðŸ” MFA"]
        TOTP[ðŸ“± TOTP]
        SMS[ðŸ“± SMS]
        Email[ðŸ“§ Email]
    end

%%{init: {'theme':'base', 'themeVariables': {'fontSize': '10px', 'fontFamily': 'Arial, sans-serif'}}}%%
graph TB
    %% Clients
    subgraph Clients["ðŸ‘¥ CLIENTS"]
        WebApp[ðŸŒ JUL Portal]
        MobileApp[ðŸ“± Mobile App]
        APIClients[ðŸ”Œ API Clients]
    end

    %% Load Balancer
    subgraph LoadBalancer["âš–ï¸ NGINX"]
        NGINX[âš–ï¸ NGINX Ingress]
    end

    %% Keycloak Cluster
    subgraph KeycloakCluster["ðŸ” KEYCLOAK CLUSTER"]
        KC1[ðŸ” Keycloak Instance 1]
        KC2[ðŸ” Keycloak Instance 2]
        KC3[ðŸ” Keycloak Instance 3]
    end

    %% Database
    subgraph Database["ðŸ—ƒï¸ DATABASE"]
        KeycloakDB[(ðŸ—ƒï¸ PostgreSQL)]
        UsersTable[(ðŸ‘¤ Users)]
        RolesTable[(ðŸ›¡ï¸ Roles)]
        SessionsTable[(ðŸ”„ Sessions)]
    end

    %% External Providers
    subgraph ExternalProviders["ðŸŒ EXTERNAL PROVIDERS"]
        LDAPProvider[ðŸ“ LDAP/AD]
        SocialProviders[ðŸ“± Social Login]
        GovernmentSSO[ðŸ›ï¸ Gov SSO]
    end

    %% JUL Services
    subgraph JULServices["âš™ï¸ JUL SERVICES"]
        CompanyService[ðŸ¢ Company Service]
        LicenseService[ðŸ“œ License Service]
        DeclarationService[ðŸ“‹ Declaration Service]
        DocumentService[ðŸ“„ Document Service]
    end

    %% API Gateway
    subgraph APIGateway["ðŸ¦ API GATEWAY"]
        Kong[ðŸ¦ Kong Gateway]
    end

    %% System Roles
    subgraph SystemRoles["ðŸ›¡ï¸ SYSTEM ROLES"]
        Admin[ðŸ‘¨â€ðŸ’¼ Admin]
        Officer[ðŸ‘® Officer]
        Supervisor[ðŸ‘¨â€ðŸ’¼ Supervisor]
        Trader[ðŸ‘¤ Trader]
        CustomsBroker[ðŸ‘¥ Customs Broker]
        FreightForwarder[ðŸš› Freight Forwarder]
        ReadOnlyUser[ðŸ‘ï¸ Read-Only User]
    end

    %% Permissions
    subgraph Permissions["ðŸ”‘ PERMISSIONS"]
        DeclarationPerms[ðŸ“‹ Declaration Permissions]
        DocumentPerms[ðŸ“„ Document Permissions]
        CompanyPerms[ðŸ¢ Company Permissions]
        ReportPerms[ðŸ“Š Reporting Permissions]
    end

    %% Authentication Protocols
    subgraph Protocols["ðŸ”‘ PROTOCOLS"]
        OAuth2[ðŸ”‘ OAuth 2.0]
        OpenIDConnect[ðŸ” OpenID Connect]
        SAML[ðŸ“œ SAML 2.0]
    end

    %% MFA Methods
    subgraph MFAMethods["ðŸ” MFA METHODS"]
        TOTPAuth[ðŸ“± TOTP]
        SMSAuth[ðŸ“± SMS]
        EmailAuth[ðŸ“§ Email]
    end

    %% Session Management
    subgraph SessionMgmt["ðŸ”„ SESSION MANAGEMENT"]
        RedisCache[âš¡ Redis Cluster]
        AccessToken[ðŸŽŸï¸ Access Token]
        RefreshToken[ðŸ”„ Refresh Token]
        IDToken[ðŸ†” ID Token]
    end

    %% User Registration Flow
    subgraph UserFlow["ðŸ‘¤ USER REGISTRATION FLOW"]
        UserRegistration[1ï¸âƒ£ User Registration]
        EmailVerification[2ï¸âƒ£ Email Verification]
        CompanyAssociation[3ï¸âƒ£ Company Association]
        RoleAssignment[4ï¸âƒ£ Role Assignment]
        MFASetup[5ï¸âƒ£ MFA Setup]
    end

    %% Main Flow Connections
    Clients --> NGINX
    NGINX --> KeycloakCluster
    KeycloakCluster --> Database
    KeycloakCluster <--> ExternalProviders
    
    Clients --> Kong
    Kong <--> KeycloakCluster
    Kong --> JULServices
    
    %% Keycloak Internal Connections
    KC1 -.-> KeycloakDB
    KC2 -.-> KeycloakDB
    KC3 -.-> KeycloakDB
    
    %% Protocol and Authentication
    KeycloakCluster --> Protocols
    KeycloakCluster --> MFAMethods
    KeycloakCluster --> SystemRoles
    SystemRoles --> Permissions
    
    %% Session and Token Management
    KeycloakCluster <--> SessionMgmt
    
    %% User Registration Flow
    UserRegistration --> EmailVerification
    EmailVerification --> CompanyAssociation
    CompanyAssociation --> RoleAssignment
    RoleAssignment --> MFASetup