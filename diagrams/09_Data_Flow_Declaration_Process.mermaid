%%{init: {'theme':'base', 'themeVariables': {'fontSize': '10px', 'fontFamily': 'Arial, sans-serif'}}}%%
graph TD
    %% User
    Trader[üë§ Trader]
    
    %% JUL System
    subgraph JUL["üèõÔ∏è JUL SYSTEM"]
        WebPortal[üåê Web Portal]
        APIGateway[ü¶ç API Gateway]
        DeclarationService[üìã Declaration Service]
        DocumentService[üìÑ Document Service]
        PaymentService[üí≥ Payment Service]
        NotificationService[üìß Notification Service]
    end
    
    %% Data Storage
    subgraph DataLayer["üóÉÔ∏è DATA"]
        DeclarationDB[(üìã Declaration DB)]
        MinIOStorage[üì¶ MinIO Storage]
        MessageQueue[üì¨ Message Queue]
    end
    
    %% External Systems
    subgraph External["üåê EXTERNAL"]
        ASYCUDA[üèõÔ∏è ASYCUDA]
        Banks[üè¶ Banks]
        SINTECE[üèõÔ∏è SINTECE]
    end

    %% Main Flow
    Trader --> WebPortal
    WebPortal --> APIGateway
    APIGateway --> DeclarationService
    
    DeclarationService --> DeclarationDB
    DeclarationService --> DocumentService
    DocumentService --> MinIOStorage
    
    DeclarationService --> ASYCUDA
    DeclarationService --> PaymentService
    PaymentService --> Banks
    
    DeclarationService --> NotificationService
    NotificationService --> Trader
    
    %% Event Processing
    DeclarationService -.-> MessageQueue
    PaymentService -.-> MessageQueue
    NotificationService -.-> MessageQueue

    %% Data Validation
    DeclarationService --> SINTECE
    
    %% Data Processing Flow Labels
    Trader -.->|1. Create Declaration| WebPortal
    WebPortal -.->|2. Submit Data| DeclarationService
    DeclarationService -.->|3. Upload Documents| DocumentService
    MasterDataService -.->|4. Validate HS Codes| DeclarationService
    DeclarationService -.->|5. Submit CUSDEC| ASYCUDA
    ASYCUDA -.->|6. Return CUSRES| DeclarationService
    DeclarationService -.->|7. Process Payment| PaymentService
    PaymentService -.->|8. Confirm Payment| BankingSystem
    NotificationService -.->|9. Send Status Update| Trader
    
    %% Data Synchronization Flows
    subgraph DataSync["üîÑ DATA SYNCHRONIZATION"]
        direction TB
        NightlySync[üåô Nightly Batch Sync<br/>02:00 AM WAT]
        ExternalDataSources[üìä External Data Sources<br/>‚Ä¢ HS Code Updates<br/>‚Ä¢ Tariff Changes<br/>‚Ä¢ Exchange Rates<br/>‚Ä¢ Regulatory Updates]
        
        NightlySync --> ExternalDataSources
        ExternalDataSources --> MasterDataService
        MasterDataService --> RedisCache
    end
    
    %% Real-time Event Processing
    subgraph EventProcessing["‚ö° REAL-TIME EVENT PROCESSING"]
        direction TB
        EventProcessor[‚ö° Event Processor<br/>RabbitMQ Consumer]
        EventTypes[üì¨ Event Types<br/>‚Ä¢ Declaration Status Change<br/>‚Ä¢ Payment Confirmation<br/>‚Ä¢ Document Upload<br/>‚Ä¢ Workflow Transition<br/>‚Ä¢ System Alerts]
        
        MessageQueue --> EventProcessor
        EventProcessor --> EventTypes
        EventTypes --> NotificationService
        EventTypes --> AuditService
        EventTypes --> WorkflowService
    end
    
    %% Performance Optimization
    subgraph Performance["üöÄ PERFORMANCE OPTIMIZATION"]
        direction TB
        CacheStrategy[‚ö° Cache Strategy<br/>‚Ä¢ Master Data Caching<br/>‚Ä¢ Session Caching<br/>‚Ä¢ Query Result Caching]
        
        LoadBalancing[‚öñÔ∏è Load Balancing<br/>‚Ä¢ Service Replicas<br/>‚Ä¢ Database Read Replicas<br/>‚Ä¢ MinIO Distribution]
        
        RedisCache --> CacheStrategy
        DeclarationService --> LoadBalancing
        DocumentService --> LoadBalancing
    end
    
    %% Data Quality and Monitoring
    subgraph DataQuality["üéØ DATA QUALITY & MONITORING"]
        direction TB
        DataValidation[‚úÖ Data Validation<br/>‚Ä¢ Schema Validation<br/>‚Ä¢ Business Rules<br/>‚Ä¢ Data Integrity Checks]
        
        MonitoringMetrics[üìä Monitoring Metrics<br/>‚Ä¢ Processing Times<br/>‚Ä¢ Error Rates<br/>‚Ä¢ System Performance<br/>‚Ä¢ Data Volume]
        
        DeclarationService --> DataValidation
        DataValidation --> MonitoringMetrics
        MonitoringMetrics --> NotificationService
    end

    %% Styling
    classDef julBox fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px,color:#000
    classDef dataBox fill:#e1f5fe,stroke:#01579b,stroke-width:2px,color:#000
    classDef externalBox fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#000
    classDef processBox fill:#fff3e0,stroke:#ef6c00,stroke-width:2px,color:#000
    classDef actorBox fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000

    class JUL julBox
    class DataLayer dataBox
    class ExternalSystems externalBox
    class DataSync,EventProcessing,Performance,DataQuality processBox
    class Trader actorBox