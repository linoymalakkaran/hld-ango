%%{init: {'theme':'base', 'themeVariables': {'fontSize': '8px', 'fontFamily': 'Arial, sans-serif'}}}%%
sequenceDiagram
    participant Company as üè¢ Trading Company
    participant JULPortal as üåê JUL Web Portal
    participant APIGateway as ü¶ç Kong API Gateway
    participant LicenseService as üìú License & Permits Service
    participant SINTECEIntegration as üèõÔ∏è SINTECE Integration
    participant SINTECE as üèõÔ∏è SINTECE System
    participant NotificationService as üìß Notification Service
    participant AuditService as üìù Audit Service
    participant WorkflowService as üîÑ Workflow Service

    Note over Company, WorkflowService: License Verification Flow

    %% 1. License Application Submission
    Company->>+JULPortal: Apply for CNCA license
    JULPortal->>+APIGateway: Submit license application
    APIGateway->>+LicenseService: POST /licenses/cnca
    
    Note over LicenseService: Validate application<br/>Check required documents<br/>Verify company status
    
    LicenseService->>+AuditService: Log license application
    AuditService-->>-LicenseService: Application logged
    
    LicenseService-->>-APIGateway: Application submitted (ID: CNCA-2025-001)
    APIGateway-->>-JULPortal: 201 Created
    JULPortal-->>-Company: Application submitted successfully

    %% 2. Internal Processing and Workflow
    LicenseService->>+WorkflowService: Start license approval workflow
    WorkflowService-->>-LicenseService: Workflow instance created
    
    LicenseService->>+NotificationService: Application received notification
    NotificationService-->>-Company: üìß CNCA application received

    %% 3. SINTECE Verification - License Validation
    LicenseService->>+SINTECEIntegration: Verify license eligibility
    
    Note over SINTECEIntegration: Prepare verification request<br/>Company validation<br/>Background checks
    
    SINTECEIntegration->>+SINTECE: POST /api/v1/license/verify
    
    Note right of SINTECE: Verification Elements:<br/>‚Ä¢ Company Registration<br/>‚Ä¢ Tax Compliance Status<br/>‚Ä¢ Previous License History<br/>‚Ä¢ Regulatory Violations<br/>‚Ä¢ Financial Standing

    %% 4. SINTECE Processing
    Note over SINTECE: Process verification request<br/>‚Ä¢ Database lookup<br/>‚Ä¢ Cross-agency validation<br/>‚Ä¢ Compliance checks<br/>‚Ä¢ Risk assessment

    SINTECE-->>-SINTECEIntegration: HTTP 200: Verification response
    
    Note right of SINTECE: Response Elements:<br/>‚Ä¢ Verification Status<br/>‚Ä¢ Compliance Score<br/>‚Ä¢ Risk Rating<br/>‚Ä¢ Required Actions<br/>‚Ä¢ Valid Until Date

    SINTECEIntegration-->>-LicenseService: Verification completed

    %% 5. License Decision Process
    alt Verification Successful
        LicenseService->>LicenseService: Update status: SUBMITTED ‚Üí APPROVED
        LicenseService->>+SINTECEIntegration: Request certificate issuance
        SINTECEIntegration->>+SINTECE: POST /api/v1/certificate/issue
        SINTECE-->>-SINTECEIntegration: Digital certificate issued
        SINTECEIntegration-->>-LicenseService: Certificate received
        
        LicenseService->>+NotificationService: License approved notification
        NotificationService-->>-Company: üìß ‚úÖ CNCA license approved
        
    else Verification Failed
        LicenseService->>LicenseService: Update status: SUBMITTED ‚Üí REJECTED
        LicenseService->>+NotificationService: License rejection notification
        NotificationService-->>-Company: üìß ‚ùå CNCA application rejected<br/>Reason: Tax compliance issues
    end

    %% 6. Certificate Management Flow
    Note over Company, SINTECE: Ongoing Certificate Management

    %% Certificate Renewal Check
    Company->>+JULPortal: Check license status
    JULPortal->>+LicenseService: GET /licenses/cnca/status
    LicenseService->>+SINTECEIntegration: Verify current validity
    SINTECEIntegration->>+SINTECE: GET /api/v1/certificate/status
    SINTECE-->>-SINTECEIntegration: Status: Valid until 2026-12-15
    SINTECEIntegration-->>-LicenseService: Certificate valid
    LicenseService-->>-JULPortal: License active
    JULPortal-->>-Company: CNCA license: Active ‚úÖ

    %% 7. Bulk Verification for Declarations
    Note over LicenseService, SINTECE: Bulk License Verification

    LicenseService->>+SINTECEIntegration: Bulk verify multiple licenses
    SINTECEIntegration->>+SINTECE: POST /api/v1/license/bulk-verify
    
    Note over SINTECE: Process bulk request<br/>‚Ä¢ Multiple license validation<br/>‚Ä¢ Batch processing<br/>‚Ä¢ Consolidated response

    SINTECE-->>-SINTECEIntegration: Bulk verification results
    SINTECEIntegration-->>-LicenseService: Results processed

    %% 8. Real-time Status Updates via Webhooks
    Note over SINTECE, NotificationService: Real-time Status Updates

    SINTECE->>+SINTECEIntegration: Webhook: License status change
    SINTECEIntegration->>+LicenseService: Update license status
    LicenseService->>LicenseService: Status: ACTIVE ‚Üí SUSPENDED
    LicenseService->>+NotificationService: Status change notification
    NotificationService-->>-Company: üìß ‚ö†Ô∏è License suspended - Action required
    LicenseService-->>-SINTECEIntegration: Status updated
    SINTECEIntegration-->>-SINTECE: Acknowledgment sent

    %% Error Handling Scenarios
    Note over SINTECEIntegration, SINTECE: Error Handling

    alt SINTECE System Unavailable
        SINTECEIntegration->>SINTECE: Verification request
        SINTECE--X SINTECEIntegration: Service unavailable (503)
        SINTECEIntegration->>SINTECEIntegration: Queue for retry<br/>Exponential backoff
        SINTECEIntegration->>+NotificationService: System delay notification
        NotificationService-->>-Company: üìß Verification delayed - System maintenance
    end

    alt Rate Limit Exceeded
        SINTECEIntegration->>SINTECE: Multiple rapid requests
        SINTECE-->>SINTECEIntegration: HTTP 429: Rate limit exceeded
        SINTECEIntegration->>SINTECEIntegration: Apply rate limiting<br/>Queue requests
        SINTECEIntegration->>+LicenseService: Processing delayed
        LicenseService-->>-SINTECEIntegration: Delay acknowledged
    end

    %% 9. Compliance Reporting
    Note over LicenseService, AuditService: Compliance and Audit Trail

    LicenseService->>+AuditService: Log all license transactions
    AuditService->>AuditService: Store audit trail<br/>‚Ä¢ Application events<br/>‚Ä¢ Verification requests<br/>‚Ä¢ Status changes<br/>‚Ä¢ Certificate actions
    AuditService-->>-LicenseService: Audit recorded

    Note over Company, WorkflowService: License Verification Complete<br/>Typical Time: 2-5 business days

    %% API Details
    Note over SINTECEIntegration, SINTECE: API Integration Details

    Note left of SINTECEIntegration: Request Format:<br/>```json<br/>{<br/>  "companyId": "NIF123456789",<br/>  "licenseType": "CNCA",<br/>  "applicationType": "NEW",<br/>  "requestDate": "2025-12-15",<br/>  "documents": [...]<br/>}<br/>```

    Note right of SINTECE: Response Format:<br/>```json<br/>{<br/>  "verificationId": "SINT-2025-001",<br/>  "status": "APPROVED",<br/>  "complianceScore": 85,<br/>  "riskRating": "LOW",<br/>  "validUntil": "2026-12-15",<br/>  "certificateId": "CNCA-2025-001"<br/>}<br/>```