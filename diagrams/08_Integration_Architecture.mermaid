%%{init: {'theme':'base', 'themeVariables': {'fontSize': '10px', 'fontFamily': 'Arial, sans-serif'}}}%%
graph TB
    %% Client Applications
    subgraph Clients["ğŸ‘¥ CLIENTS"]
        WebPortal[ğŸŒ JUL Portal]
        MobileApp[ğŸ“± Mobile App]
        APIClients[ğŸ”Œ API Clients]
    end

    %% API Gateway
    subgraph Gateway["ğŸ¦ GATEWAY"]
        Kong[ğŸ¦ Kong Gateway]
    end

    %% Authentication
    subgraph Auth["ğŸ” AUTH"]
        Keycloak[ğŸ” Keycloak]
    end

    %% JUL Services
    subgraph JULServices["âš™ï¸ JUL SERVICES"]
        CompanyMgmt[ğŸ¢ Company]
        LicensePermit[ğŸ“œ License]
        AgentNomination[ğŸ‘¥ Agent]
        DeclarationMgmt[ğŸ“‹ Declaration]
        DocumentMgmt[ğŸ“„ Document]
        MasterData[ğŸ—‚ï¸ Master Data]
    end

    %% Integration Layer
    subgraph IntegrationLayer["ğŸ”Œ INTEGRATION"]
        ASYCUDAIntegration[ğŸ›ï¸ ASYCUDA Service]
        SINTECEIntegration[ğŸ›ï¸ SINTECE Service]
        OGAIntegration[ğŸ›ï¸ OGA Service]
        PaymentIntegration[ğŸ’³ Payment Service]
    end

    %% External Systems
    subgraph ExternalSystems["ğŸŒ EXTERNAL"]
        ASYCUDA[ğŸ›ï¸ ASYCUDA]
        SINTECE[ğŸ›ï¸ SINTECE]
        OGAs[ğŸ›ï¸ Gov Agencies]
        Banks[ğŸ¦ Banks]
    end

    %% Data Storage
    subgraph DataStorage["ğŸ—ƒï¸ DATA"]
        PostgreSQL[(ğŸ—ƒï¸ PostgreSQL)]
        MinIO[ğŸ“¦ MinIO]
        Redis[âš¡ Redis]
        RabbitMQ[ğŸ° RabbitMQ]
    end

    %% Connections
    Clients --> Kong
    Kong <--> Keycloak
    Kong --> JULServices
    Kong --> IntegrationLayer
    
    JULServices <--> DataStorage
    IntegrationLayer <--> DataStorage
    
    ASYCUDAIntegration <--> ASYCUDA
    SINTECEIntegration <--> SINTECE
    OGAIntegration <--> OGAs
    PaymentIntegration <--> Banks
        
        PaymentIntegration[ğŸ’³ Payment Integration<br/>â€¢ Banking API Integration<br/>â€¢ Payment Processing<br/>â€¢ Transaction Verification<br/>â€¢ Reconciliation<br/>Protocol: REST/JSON - Synchronous]
    end

    %% Message Queue
    subgraph MessageBus["ğŸ“¬ MESSAGE BUS"]
        RabbitMQ[ğŸ° RabbitMQ Cluster<br/>â€¢ Event-Driven Communication<br/>â€¢ Asynchronous Processing<br/>â€¢ Message Routing & Queuing<br/>â€¢ Dead Letter Handling<br/>â€¢ High Availability]
    end

    %% Data Layer
    subgraph DataStorage["ğŸ—ƒï¸ DATA STORAGE LAYER"]
        direction TB
        
        subgraph Databases["Database Cluster"]
            PostgreSQL[(ğŸ—ƒï¸ PostgreSQL 15+<br/>Database per Microservice<br/>Primary + 2 Replicas)]
        end
        
        subgraph ObjectStorage["Object Storage"]
            MinIO[ğŸ“¦ MinIO Cluster<br/>Document Storage<br/>S3-Compatible API]
        end
        
        subgraph Cache["Cache Layer"]
            Redis[âš¡ Redis Cluster<br/>Session & Application Cache<br/>High Performance]
        end
    end

    %% External Systems
    subgraph ExternalSystems["ğŸŒ EXTERNAL SYSTEMS"]
        direction TB
        
        subgraph GovernmentSystems["Government Systems"]
            ASYCUDA[ğŸ›ï¸ ASYCUDA<br/>Angola Customs Authority (AGT)<br/>---<br/>â€¢ Customs Declaration Processing<br/>â€¢ Duty Calculation<br/>â€¢ Clearance Authorization<br/>â€¢ Risk Assessment<br/>Protocol: SOAP/XML]
            
            SINTECE[ğŸ›ï¸ SINTECE<br/>Angola Single Window<br/>---<br/>â€¢ License Verification<br/>â€¢ Certificate Validation<br/>â€¢ Regulatory Compliance<br/>â€¢ Cross-agency Coordination<br/>Protocol: REST/JSON]
            
            OGAs[ğŸ›ï¸ Other Government Agencies<br/>Health, Agriculture, Standards<br/>---<br/>â€¢ Import/Export Permits<br/>â€¢ Regulatory Approvals<br/>â€¢ Certificate Issuance<br/>â€¢ Compliance Verification<br/>Protocol: REST/JSON]
        end
        
        subgraph BankingSystems["Banking & Payment Systems"]
            CommercialBanks[ğŸ¦ Commercial Banks<br/>Payment Processing<br/>Transaction Verification<br/>Account Management]
            
            PaymentGateways[ğŸ’³ Payment Gateways<br/>Card Processing<br/>Mobile Money<br/>Digital Wallets]
            
            CentralBank[ğŸ›ï¸ Central Bank<br/>Exchange Rates<br/>Monetary Policy<br/>Compliance Reporting]
        end
        
        subgraph ExternalAPIs["External Data Sources"]
            CurrencyAPI[ğŸ’± Currency Exchange APIs<br/>Real-time Exchange Rates<br/>Historical Data]
            
            HSCodeAPI[ğŸ“Š HS Code APIs<br/>WCO Updates<br/>Classification Changes<br/>Tariff Updates]
        end
    end

    %% Monitoring and Logging
    subgraph Monitoring["ğŸ“Š MONITORING & LOGGING"]
        direction TB
        
        Prometheus[ğŸ“ˆ Prometheus<br/>Metrics Collection<br/>Performance Monitoring]
        
        Grafana[ğŸ“Š Grafana<br/>Dashboards<br/>Visualization<br/>Alerting]
        
        ELK[ğŸ“‹ ELK Stack<br/>Centralized Logging<br/>Log Analysis<br/>Search & Analytics]
        
        Jaeger[ğŸ” Jaeger<br/>Distributed Tracing<br/>Performance Analysis<br/>Request Flow Tracking]
    end

    %% Connection Flows
    %% Client to Gateway
    Clients --> Kong
    Kong <--> Keycloak
    
    %% Gateway to Services
    Kong --> JULServices
    Kong --> IntegrationLayer
    
    %% Internal Service Communication
    JULServices <--> DataStorage
    JULServices <--> RabbitMQ
    IntegrationLayer <--> DataStorage
    IntegrationLayer <--> RabbitMQ
    
    %% Cross-service communication
    CoreBusiness <-.-> CrossCutting
    CoreBusiness <-.-> IntegrationLayer
    
    %% External Integration Flows
    ASYCUDAIntegration <--> ASYCUDA
    SINTECEIntegration <--> SINTECE
    OGAIntegration <--> OGAs
    PaymentIntegration <--> BankingSystems
    
    %% Data source integrations
    MasterData <-.-> ExternalAPIs
    PaymentIntegration <-.-> CentralBank
    
    %% Monitoring connections
    Monitoring -.-> JULServices
    Monitoring -.-> IntegrationLayer
    Monitoring -.-> DataStorage
    Monitoring -.-> Kong
    
    %% Event flows via message bus
    JULServices <-.-> RabbitMQ
    IntegrationLayer <-.-> RabbitMQ
    
    %% Authentication flows
    JULServices -.-> Keycloak
    IntegrationLayer -.-> Keycloak

    %% Styling
    classDef clientBox fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#000
    classDef gatewayBox fill:#e8eaf6,stroke:#3f51b5,stroke-width:3px,color:#000
    classDef julServiceBox fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px,color:#000
    classDef integrationBox fill:#fff3e0,stroke:#ef6c00,stroke-width:2px,color:#000
    classDef dataBox fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    classDef externalBox fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#000
    classDef monitorBox fill:#f1f8e9,stroke:#33691e,stroke-width:2px,color:#000

    class Clients clientBox
    class Gateway,Auth gatewayBox
    class JULServices julServiceBox
    class IntegrationLayer integrationBox
    class DataStorage,MessageBus dataBox
    class ExternalSystems externalBox
    class Monitoring monitorBox