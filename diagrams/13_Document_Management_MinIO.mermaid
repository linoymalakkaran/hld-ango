%%{init: {'theme':'base', 'themeVariables': {'fontSize': '10px', 'fontFamily': 'Arial, sans-serif'}}}%%
graph TB
    %% Client Applications
    subgraph Clients["ğŸ‘¥ CLIENTS"]
        WebPortal[ğŸŒ Web Portal]
        MobileApp[ğŸ“± Mobile App]
        APIClients[ğŸ”Œ API Clients]
    end

    %% Gateway
    subgraph Gateway["ğŸšª GATEWAY"]
        NGINX[âš–ï¸ NGINX]
        Kong[ğŸ¦ Kong Gateway]
    end

    %% Document Service
    subgraph DocumentService["ğŸ“„ DOCUMENT SERVICE"]
        DocService1[ğŸ“„ Document Service 1]
        DocService2[ğŸ“„ Document Service 2]
        DocServiceN[ğŸ“„ Document Service N]
        
        UploadHandler[ğŸ“¤ Upload Handler]
        ValidationEngine[âœ… Validation Engine]
        StorageManager[ğŸ’¾ Storage Manager]
    end

    %% MinIO Cluster
    subgraph MinIOCluster["ğŸ“¦ MINIO CLUSTER"]
        MinIO1[ğŸ“¦ MinIO Node 1]
        MinIO2[ğŸ“¦ MinIO Node 2]
        MinIO3[ğŸ“¦ MinIO Node 3]
        MinIO4[ğŸ“¦ MinIO Node 4]
    end

    %% Database
    subgraph Database["ğŸ—ƒï¸ METADATA DB"]
        DocumentDB[(ğŸ—ƒï¸ PostgreSQL)]
        FilesTable[(ğŸ“„ Files Table)]
        MetadataTable[(ğŸ“ Metadata Table)]
    end

    %% Security
    subgraph Security["ğŸ›¡ï¸ SECURITY"]
        Encryption[ğŸ”’ Encryption]
        AccessControl[ğŸ‘¤ Access Control]
        VirusScanning[ğŸ¦  Virus Scanning]
    end

    %% Document Types
    subgraph DocumentTypes["ğŸ“ DOCUMENT TYPES"]
        PDFDocs[ğŸ“„ PDF Documents]
        ImageDocs[ğŸ–¼ï¸ Image Documents]
        OfficeDocs[ğŸ“ Office Documents]
    end

    %% Backup
    subgraph Backup["ğŸ’¾ BACKUP"]
        LocalBackup[ğŸ“… Local Backup]
        OffsiteBackup[ğŸŒ Offsite Backup]
    end

    %% Connections
    Clients --> NGINX
    NGINX --> Kong
    Kong --> DocumentService
    
    DocumentService --> MinIOCluster
    DocumentService --> Database
    DocumentService --> Security
    
    MinIOCluster --> Backup
    DocumentService --> DocumentTypes
        direction TB
        
        subgraph MinIONodes["MinIO Nodes"]
            MinIO1[ğŸ“¦ MinIO Node 1<br/>Storage Server<br/>10.20.2.10]
            MinIO2[ğŸ“¦ MinIO Node 2<br/>Storage Server<br/>10.20.2.11]
            MinIO3[ğŸ“¦ MinIO Node 3<br/>Storage Server<br/>10.20.2.12]
            MinIO4[ğŸ“¦ MinIO Node 4<br/>Storage Server<br/>10.20.2.13]
            MinIO5[ğŸ“¦ MinIO Node 5<br/>Storage Server<br/>10.20.2.14]
            MinIO6[ğŸ“¦ MinIO Node 6<br/>Storage Server<br/>10.20.2.15]
        end
        
        subgraph MinIOFeatures["MinIO Features"]
            S3Compatibility[ğŸ”Œ S3 Compatibility<br/>â€¢ Amazon S3 API<br/>â€¢ SDK Support<br/>â€¢ Tool Compatibility]
            
            ErasureCoding[ğŸ›¡ï¸ Erasure Coding<br/>â€¢ Data Protection<br/>â€¢ N/2 Fault Tolerance<br/>â€¢ Storage Efficiency]
            
            Encryption[ğŸ” Encryption<br/>â€¢ Server-Side Encryption<br/>â€¢ Client-Side Encryption<br/>â€¢ Key Management]
            
            Replication[ğŸ”„ Cross-Site Replication<br/>â€¢ Disaster Recovery<br/>â€¢ Geographic Distribution<br/>â€¢ Automatic Sync]
        end
        
        subgraph BucketStructure["Bucket Organization"]
            ProdBuckets[ğŸ”´ Production Buckets<br/>â€¢ jul-documents-2025<br/>â€¢ jul-certificates<br/>â€¢ jul-declarations<br/>â€¢ jul-attachments]
            
            StagingBuckets[ğŸŸ¡ Staging Buckets<br/>â€¢ jul-staging-docs<br/>â€¢ jul-test-uploads<br/>â€¢ jul-validation-temp]
            
            BackupBuckets[ğŸ’¾ Backup Buckets<br/>â€¢ jul-backup-daily<br/>â€¢ jul-backup-monthly<br/>â€¢ jul-archive-yearly]
        end
    end

    %% PostgreSQL Metadata Database
    subgraph MetadataDB["ğŸ—ƒï¸ METADATA DATABASE"]
        direction TB
        
        DocumentMetadataDB[(ğŸ—ƒï¸ PostgreSQL<br/>document_metadata_db)]
        
        subgraph MetadataTables["Metadata Tables"]
            DocumentsTable[(ğŸ“„ documents<br/>â€¢ document_id<br/>â€¢ filename<br/>â€¢ content_type<br/>â€¢ size_bytes<br/>â€¢ upload_date<br/>â€¢ uploaded_by)]
            
            VersionsTable[(ğŸ”„ document_versions<br/>â€¢ version_id<br/>â€¢ document_id<br/>â€¢ version_number<br/>â€¢ minio_object_key<br/>â€¢ created_date)]
            
            MetadataTable[(ğŸ“Š document_metadata<br/>â€¢ document_id<br/>â€¢ key<br/>â€¢ value<br/>â€¢ metadata_type)]
            
            AccessLogTable[(ğŸ“ document_access_log<br/>â€¢ access_id<br/>â€¢ document_id<br/>â€¢ user_id<br/>â€¢ action<br/>â€¢ timestamp)]
            
            RetentionTable[(â° retention_policies<br/>â€¢ policy_id<br/>â€¢ document_type<br/>â€¢ retention_years<br/>â€¢ auto_delete)]
        end
    end

    %% Document Processing Pipeline
    subgraph ProcessingPipeline["ğŸ”„ DOCUMENT PROCESSING PIPELINE"]
        direction LR
        
        subgraph UploadPipeline["Upload Pipeline"]
            Step1[1ï¸âƒ£ Receive Upload<br/>Validate File]
            Step2[2ï¸âƒ£ Virus Scan<br/>Security Check]
            Step3[3ï¸âƒ£ Extract Metadata<br/>OCR Processing]
            Step4[4ï¸âƒ£ Store in MinIO<br/>Encrypt & Save]
            Step5[5ï¸âƒ£ Update Database<br/>Metadata & Index]
            
            Step1 --> Step2
            Step2 --> Step3
            Step3 --> Step4
            Step4 --> Step5
        end
        
        subgraph ValidationPipeline["Validation Pipeline"]
            Validate1[1ï¸âƒ£ Format Check<br/>File Type Validation]
            Validate2[2ï¸âƒ£ Content Analysis<br/>Document Structure]
            Validate3[3ï¸âƒ£ Business Rules<br/>Required Fields]
            Validate4[4ï¸âƒ£ Compliance Check<br/>Regulatory Requirements]
            
            Validate1 --> Validate2
            Validate2 --> Validate3
            Validate3 --> Validate4
        end
    end

    %% Security and Access Control
    subgraph Security["ğŸ›¡ï¸ SECURITY & ACCESS CONTROL"]
        direction TB
        
        subgraph Authentication["Authentication"]
            KeycloakAuth[ğŸ” Keycloak Integration<br/>â€¢ OAuth 2.0 Tokens<br/>â€¢ Role-Based Access<br/>â€¢ Permission Validation]
        end
        
        subgraph Encryption["Encryption"]
            TransitEncryption[ğŸ”’ Encryption in Transit<br/>â€¢ TLS 1.3<br/>â€¢ HTTPS Only<br/>â€¢ Certificate Management]
            
            RestEncryption[ğŸ”’ Encryption at Rest<br/>â€¢ AES-256<br/>â€¢ MinIO Server-Side<br/>â€¢ Key Rotation]
            
            FieldEncryption[ğŸ”’ Field-Level Encryption<br/>â€¢ Sensitive Data<br/>â€¢ PII Protection<br/>â€¢ Compliance Requirements]
        end
        
        subgraph AccessControl["Access Control"]
            RolePermissions[ğŸ›¡ï¸ Role-Based Permissions<br/>â€¢ Document Owner<br/>â€¢ Company Access<br/>â€¢ Government Access<br/>â€¢ Public Access]
            
            IPWhitelist[ğŸŒ IP Whitelisting<br/>â€¢ Restricted Access<br/>â€¢ Government Networks<br/>â€¢ Trusted Partners]
        end
    end

    %% Monitoring and Analytics
    subgraph Monitoring["ğŸ“Š MONITORING & ANALYTICS"]
        direction TB
        
        subgraph Metrics["Storage Metrics"]
            StorageUsage[ğŸ“Š Storage Usage<br/>â€¢ Total Storage<br/>â€¢ Bucket Distribution<br/>â€¢ Growth Trends]
            
            PerformanceMetrics[âš¡ Performance Metrics<br/>â€¢ Upload/Download Speed<br/>â€¢ Throughput<br/>â€¢ Latency]
            
            HealthMetrics[â¤ï¸ Health Metrics<br/>â€¢ Node Status<br/>â€¢ Disk Usage<br/>â€¢ Network Performance]
        end
        
        subgraph Alerts["Alerting"]
            StorageAlerts[âš ï¸ Storage Alerts<br/>â€¢ Disk Space Warning<br/>â€¢ Node Failure<br/>â€¢ Performance Degradation]
            
            SecurityAlerts[ğŸš¨ Security Alerts<br/>â€¢ Unauthorized Access<br/>â€¢ Virus Detection<br/>â€¢ Unusual Activity]
        end
    end

    %% Backup and Disaster Recovery
    subgraph BackupDR["ğŸ’¾ BACKUP & DISASTER RECOVERY"]
        direction TB
        
        subgraph LocalBackup["Local Backup"]
            DailyBackup[ğŸ“… Daily Backup<br/>Incremental Backup<br/>Local Storage]
            
            WeeklyBackup[ğŸ“… Weekly Backup<br/>Full Backup<br/>Local Storage]
        end
        
        subgraph OffsiteBackup["Offsite Backup"]
            MonthlyBackup[ğŸ“… Monthly Backup<br/>Full Archive<br/>Remote Site]
            
            CrossSiteReplication[ğŸ”„ Cross-Site Replication<br/>Real-time Sync<br/>DR Site]
        end
    end

    %% Data Flow Connections
    Clients --> NGINX
    NGINX --> Kong
    Kong --> DocumentService
    
    DocumentService --> MinIOCluster
    DocumentService --> MetadataDB
    
    ProcessingPipeline --> MinIOCluster
    ProcessingPipeline --> MetadataDB
    
    Security --> DocumentService
    Security --> MinIOCluster
    
    Monitoring --> MinIOCluster
    Monitoring --> DocumentService
    
    MinIOCluster --> BackupDR
    MetadataDB --> BackupDR

    %% Document Lifecycle Flow
    subgraph DocumentLifecycle["ğŸ“‹ DOCUMENT LIFECYCLE"]
        direction LR
        
        Upload[ğŸ“¤ Upload]
        Processing[ğŸ”„ Processing]
        Validation[âœ… Validation]
        Storage[ğŸ’¾ Storage]
        Access[ğŸ“¥ Access]
        Archive[ğŸ“¦ Archive]
        Delete[ğŸ—‘ï¸ Delete]
        
        Upload --> Processing
        Processing --> Validation
        Validation --> Storage
        Storage --> Access
        Access --> Archive
        Archive --> Delete
    end

    %% Sample API Endpoints
    subgraph APIEndpoints["ğŸ”Œ API ENDPOINTS"]
        direction TB
        
        UploadAPI[POST /api/documents/upload<br/>Multipart file upload]
        DownloadAPI[GET /api/documents/{id}/download<br/>Stream file download]
        MetadataAPI[GET /api/documents/{id}/metadata<br/>Document information]
        SearchAPI[GET /api/documents/search<br/>Document search & filter]
        DeleteAPI[DELETE /api/documents/{id}<br/>Soft delete document]
    end

    %% Styling
    classDef serviceBox fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px,color:#000
    classDef storageBox fill:#e1f5fe,stroke:#01579b,stroke-width:3px,color:#000
    classDef dbBox fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    classDef securityBox fill:#fff3e0,stroke:#ef6c00,stroke-width:2px,color:#000
    classDef processBox fill:#f1f8e9,stroke:#33691e,stroke-width:2px,color:#000
    classDef monitorBox fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#000

    class DocumentService,APIEndpoints serviceBox
    class MinIOCluster storageBox
    class MetadataDB dbBox
    class Security securityBox
    class ProcessingPipeline,DocumentLifecycle processBox
    class Monitoring,BackupDR monitorBox