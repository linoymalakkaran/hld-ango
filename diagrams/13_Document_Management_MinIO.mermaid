%%{init: {'theme':'base', 'themeVariables': {'fontSize': '10px', 'fontFamily': 'Arial, sans-serif'}}}%%
graph TB
    %% Client Applications
    subgraph Clients["ğŸ‘¥ CLIENTS"]
        WebPortal[ğŸŒ Web Portal]
        MobileApp[ğŸ“± Mobile App]
        APIClients[ğŸ”Œ API Clients]
    end

    %% Gateway
    subgraph Gateway["ğŸšª GATEWAY"]
        NGINX[âš–ï¸ NGINX]
        Kong[ğŸ¦ Kong Gateway]
    end

    %% Document Service
    subgraph DocumentService["ğŸ“„ DOCUMENT SERVICE"]
        DocService1[ğŸ“„ Document Service 1]
        DocService2[ğŸ“„ Document Service 2]
        UploadHandler[ğŸ“¤ Upload Handler]
        ValidationEngine[âœ… Validation Engine]
        StorageManager[ğŸ’¾ Storage Manager]
    end

    %% MinIO Cluster
    subgraph MinIOCluster["ğŸ“¦ MINIO CLUSTER"]
        MinIO1[ğŸ“¦ MinIO Node 1]
        MinIO2[ğŸ“¦ MinIO Node 2]
        MinIO3[ğŸ“¦ MinIO Node 3]
        MinIO4[ğŸ“¦ MinIO Node 4]
        MinIO5[ğŸ“¦ MinIO Node 5]
        MinIO6[ğŸ“¦ MinIO Node 6]
    end

    %% MinIO Features
    subgraph MinIOFeatures["ğŸ”§ MINIO FEATURES"]
        S3Compatibility[ğŸ”Œ S3 Compatibility]
        ErasureCoding[ğŸ›¡ï¸ Erasure Coding]
        EncryptionFeature[ğŸ” Encryption]
        Replication[ğŸ”„ Cross-Site Replication]
    end

    %% Database
    subgraph MetadataDB["ğŸ—ƒï¸ METADATA DB"]
        DocumentDB[(ğŸ—ƒï¸ PostgreSQL)]
        DocumentsTable[(ğŸ“„ Documents Table)]
        VersionsTable[(ğŸ”„ Versions Table)]
        MetadataTable[(ğŸ“Š Metadata Table)]
        AccessLogTable[(ğŸ“ Access Log Table)]
    end

    %% Bucket Organization
    subgraph BucketStructure["ğŸ“ BUCKET STRUCTURE"]
        ProdBuckets[ğŸ”´ Production Buckets]
        StagingBuckets[ğŸŸ¡ Staging Buckets]
        BackupBuckets[ğŸ’¾ Backup Buckets]
    end

    %% Security
    subgraph Security["ğŸ›¡ï¸ SECURITY"]
        KeycloakAuth[ğŸ” Keycloak Auth]
        TransitEncryption[ğŸ”’ Transit Encryption]
        RestEncryption[ğŸ”’ Rest Encryption]
        AccessControl[ğŸ‘¤ Access Control]
        VirusScanning[ğŸ¦  Virus Scanning]
    end

    %% Document Processing
    subgraph ProcessingPipeline["ğŸ”„ PROCESSING PIPELINE"]
        ReceiveUpload[1ï¸âƒ£ Receive Upload]
        VirusScan[2ï¸âƒ£ Virus Scan]
        ExtractMetadata[3ï¸âƒ£ Extract Metadata]
        StoreMinIO[4ï¸âƒ£ Store in MinIO]
        UpdateDatabase[5ï¸âƒ£ Update Database]
    end

    %% Document Types
    subgraph DocumentTypes["ğŸ“ DOCUMENT TYPES"]
        PDFDocs[ğŸ“„ PDF Documents]
        ImageDocs[ğŸ–¼ï¸ Image Documents]
        OfficeDocs[ğŸ“ Office Documents]
    end

    %% Monitoring
    subgraph Monitoring["ğŸ“Š MONITORING"]
        StorageUsage[ğŸ“Š Storage Usage]
        PerformanceMetrics[âš¡ Performance Metrics]
        HealthMetrics[â¤ï¸ Health Metrics]
        StorageAlerts[âš ï¸ Storage Alerts]
        SecurityAlerts[ğŸš¨ Security Alerts]
    end

    %% Backup and DR
    subgraph BackupDR["ğŸ’¾ BACKUP & DR"]
        DailyBackup[ğŸ“… Daily Backup]
        WeeklyBackup[ğŸ“… Weekly Backup]
        MonthlyBackup[ğŸ“… Monthly Backup]
        CrossSiteReplication[ğŸ”„ Cross-Site Replication]
    end

    %% Document Lifecycle
    subgraph DocumentLifecycle["ğŸ“‹ DOCUMENT LIFECYCLE"]
        Upload[ğŸ“¤ Upload]
        Processing[ğŸ”„ Processing]
        Validation[âœ… Validation]
        Storage[ğŸ’¾ Storage]
        Access[ğŸ“¥ Access]
        Archive[ğŸ“¦ Archive]
        Delete[ğŸ—‘ï¸ Delete]
    end

    %% API Endpoints
    subgraph APIEndpoints["ğŸ”Œ API ENDPOINTS"]
        UploadAPI[POST /upload]
        DownloadAPI[GET /download]
        MetadataAPI[GET /metadata]
        SearchAPI[GET /search]
        DeleteAPI[DELETE /delete]
    end

    %% Main Flow Connections
    Clients --> NGINX
    NGINX --> Kong
    Kong --> DocumentService
    
    DocumentService --> MinIOCluster
    DocumentService --> MetadataDB
    DocumentService --> Security
    
    MinIOCluster --> MinIOFeatures
    MinIOCluster --> BucketStructure
    
    %% Processing Flow
    ReceiveUpload --> VirusScan
    VirusScan --> ExtractMetadata
    ExtractMetadata --> StoreMinIO
    StoreMinIO --> UpdateDatabase
    
    %% Document Lifecycle Flow
    Upload --> Processing
    Processing --> Validation
    Validation --> Storage
    Storage --> Access
    Access --> Archive
    Archive --> Delete
    
    %% Supporting Connections
    DocumentService --> ProcessingPipeline
    DocumentService --> DocumentTypes
    DocumentService --> APIEndpoints
    
    MinIOCluster --> BackupDR
    MinIOCluster --> Monitoring
    Security --> MinIOCluster
    
    ProcessingPipeline --> MinIOCluster
    ProcessingPipeline --> MetadataDB