%%{init: {'theme':'base', 'themeVariables': {'fontSize': '8px', 'fontFamily': 'Arial, sans-serif'}}}%%
graph TB
    %% External Clients
    subgraph Clients["ğŸ‘¥ CLIENTS"]
        WebBrowser[ğŸŒ Web Traders/Brokers]
        MobileApp[ğŸ“± Mobile Officers]
        APIClients[ğŸ”Œ API 3rd Party]
    end

    %% API Gateway Layer
    subgraph APIGateway["ğŸ¦ API GATEWAY"]
        Kong[ğŸ¦ Kong :8000 R:3<br/>â€¢ Auth & Rate Limiting<br/>â€¢ Caching & Analytics]
    end

    %% Authentication Layer
    subgraph AuthLayer["ğŸ” AUTH"]
        Keycloak[ğŸ” Keycloak :8080 R:3<br/>â€¢ OAuth/SAML<br/>â€¢ MFA & RBAC]
    end

    %% Core Business Services
    subgraph CoreServices["âš™ï¸ CORE SERVICES"]
        direction TB
        
        CompanyService[ğŸ¢ Company :8081 R:2<br/>Registration & Profile<br/>DB: company_db]
        
        LicenseService[ğŸ“œ License :8082 R:2<br/>CNCA & Permits<br/>DB: license_db]
        
        AgentService[ğŸ‘¥ Agent :8083 R:2<br/>Broker Nominations<br/>DB: agent_db]
        
        DeclarationService[ğŸ“‹ Declaration :8084 R:3<br/>DU & Payment & Tracking<br/>DB: declaration_db]
        
        DocumentService[ğŸ“„ Document :8085 R:2<br/>Upload & MinIO Storage<br/>DB: doc_meta_db]
        
        MasterDataService[ğŸ—‚ï¸ MasterData :8086 R:2<br/>HS Codes & Sync<br/>DB: masterdata_db]
    end

    %% Integration Services
    subgraph IntegrationServices["ğŸ”Œ INTEGRATION"]
        direction TB
        
        ASYCUDAService[ğŸ›ï¸ ASYCUDA :9081 R:2<br/>SOAP CUSDEC/CUSRES<br/>Declaration Submit]
        
        SINTECEService[ğŸ›ï¸ SINTECE :9082 R:2<br/>REST License Verify<br/>Certificate Valid]
        
        OGAService[ğŸ›ï¸ OGA :9083 R:2<br/>Multi-Agency Permits<br/>REST Async]
    end

    %% Cross-Cutting Services
    subgraph CrossCuttingServices["ğŸ”„ CROSS-CUTTING"]
        direction TB
        
        IAMService[ğŸ” IAM :8080 R:3<br/>Auth & Role Mgmt<br/>DB: keycloak_db]
        
        NotificationService[ğŸ“§ Notification :8089 R:2<br/>Email/SMS/Push<br/>DB: notification_db]
        
        WorkflowService[ğŸ”„ Workflow :8090 R:2<br/>BPM Camunda<br/>DB: camunda_db]
        
        AuditService[ğŸ“ Audit :8091 R:2<br/>Activity Logging 7yr<br/>DB: audit_db]
        
        ReportingService[ğŸ“Š Reporting :8092 R:2<br/>Analytics & Reports<br/>DB: reporting_db]
    end

    %% Data Layer
    subgraph DataLayer["ğŸ—ƒï¸ DATA"]
        direction TB
        
        subgraph Databases["PostgreSQL Cluster"]
            PostgreSQLPrimary[(ğŸ—ƒï¸ Primary)]
            PostgreSQLReplica1[(ğŸ—ƒï¸ Replica1)]
        end
        
        subgraph ObjectStorage["Object Storage"]
            MinIOCluster[ğŸ“¦ MinIO Cluster S3-Compatible]
        end
        
        subgraph Cache["Cache"]
            RedisCluster[âš¡ Redis Cluster & Sentinel]
        end
        
        subgraph MessageQueue["Queue"]
            RabbitMQCluster[ğŸ° RabbitMQ Cluster HA]
        end
    end

    %% External Systems
    subgraph ExternalSystems["ğŸŒ EXTERNAL"]
        direction TB
        
        ASYCUDA[ğŸ›ï¸ ASYCUDA AGT<br/>SOAP CUSDEC/CUSRES]
        SINTECE[ğŸ›ï¸ SINTECE<br/>REST License & Certs]
        OGAs[ğŸ›ï¸ Gov Agencies<br/>REST Multi-Agency]
        BankingSystems[ğŸ¦ Banking<br/>REST Payment]
    end

    %% Connections
    Clients --> Kong
    Kong <--> Keycloak
    Kong --> CoreServices
    Kong --> IntegrationServices
    Kong --> CrossCuttingServices

    CoreServices <--> Databases
    CoreServices <--> ObjectStorage
    CoreServices <--> Cache

    ASYCUDAService <--> ASYCUDA
    SINTECEService <--> SINTECE
    OGAService <--> OGAs
    DeclarationService <--> BankingSystems

    %% Inter-service messaging
    CoreServices <-.-> RabbitMQCluster
    IntegrationServices <-.-> RabbitMQCluster
    CrossCuttingServices <-.-> RabbitMQCluster

    %% Auth flows
    CoreServices -.-> Keycloak
    IntegrationServices -.-> Keycloak

    %% Audit and notifications
    CoreServices -.-> AuditService
    CoreServices -.-> NotificationService

    %% Styling for A4
    classDef default fill:#f9f9f9,stroke:#333,stroke-width:1px,font-size:8px
    classDef coreBox fill:#e8f5e8,stroke:#2e7d32,stroke-width:1px
    classDef integrationBox fill:#fff3e0,stroke:#ef6c00,stroke-width:1px
    classDef crossCuttingBox fill:#f3e5f5,stroke:#7b1fa2,stroke-width:1px
    classDef dataBox fill:#e1f5fe,stroke:#01579b,stroke-width:1px
    classDef externalBox fill:#ffebee,stroke:#c62828,stroke-width:1px
    classDef gatewayBox fill:#e8eaf6,stroke:#3f51b5,stroke-width:1px

    class CoreServices coreBox
    class IntegrationServices integrationBox
    class CrossCuttingServices crossCuttingBox
    class DataLayer dataBox
    class ExternalSystems externalBox
    class APIGateway,AuthLayer gatewayBox